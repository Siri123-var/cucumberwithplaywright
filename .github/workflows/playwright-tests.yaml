name: Playwright Cucumber Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 11 * * *'
  workflow_dispatch:

permissions:
  contents: write # This gives write permission to GitHub Actions
  pages: write
  id-token: write

jobs:
  test:
    runs-on: windows-latest

    env:
      SCREENSHOT_DIR: artifacts/screenshots
      REPORT_DIR: artifacts/cucumber-report

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm config ls
          npm ci
        shell: pwsh

      - name: Install Playwright
        run: npx playwright install chromium
        shell: pwsh

      - name: Create directories
        run: |
          Remove-Item -Path "test-results" -Recurse -Force -ErrorAction Ignore
          Remove-Item -Path "artifacts" -Recurse -Force -ErrorAction Ignore
          New-Item -Path "test-results" -ItemType Directory -Force
          New-Item -Path "artifacts/screenshots" -ItemType Directory -Force
          New-Item -Path "artifacts/cucumber-report" -ItemType Directory -Force
        shell: pwsh

      # - name: Run tests
      #   run: npm run test
      #   continue-on-error: true
      #   shell: pwsh

      # - name: Generate report
      #   run: npm run report
      #   continue-on-error: true
      #   shell: pwsh
      - name: Run tests
        run: |
          cucumber-js --config cucumber.json --format json:test-results/cucumber-report.json --format summary
          echo "Test execution completed"
          dir test-results
          type test-results\cucumber-report.json
        shell: pwsh
        continue-on-error: true

      - name: Generate report
        run: |
          echo "Generating report..."
          node src/test/helper/report.js
          echo "Report generation completed"
          dir artifacts\cucumber-report
        shell: pwsh
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            test-results/
            artifacts/
          retention-days: 30
          compression-level: 9

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./artifacts/cucumber-report
          destination_dir: reports/${{ github.run_number }}
          enable_jekyll: false
          allow_empty_commit: true
          force_orphan: true
          commit_message: "Deploy test report for run ${{ github.run_number }}"
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

  notify:
    needs: test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check test status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const run_id = context.runId;
            const run_number = context.runNumber;
            
            const summary = `
            ðŸŽ­ Playwright Test Run #${run_number}
            
            Status: ${context.job.status}
            Workflow: ${context.workflow}
            
            View Results: https://github.com/${owner}/${repo}/actions/runs/${run_id}
            `;
            
            if (context.issue.number) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.issue.number,
                body: summary
              });
            }